<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ translations.title }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --midnight-blue: #1a1f3a;
            --charcoal: #2c3e50;
            --slate: #34495e;
            --accent: #3498db;
            --accent-hover: #2980b9;
            --text-light: #ecf0f1;
            --text-dark: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--midnight-blue) 0%, var(--charcoal) 100%);
            color: var(--text-light);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header */
        header {
            background: rgba(26, 31, 58, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent);
        }
        
        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .donate-btn {
            background: var(--success);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-block;
        }
        
        .donate-btn:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }
        
        .lang-selector {
            display: flex;
            gap: 0.5rem;
        }
        
        .lang-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-light);
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .lang-btn:hover, .lang-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }
        
        /* Main Content */
        main {
            padding: 2rem 0;
        }
        
        .hero {
            text-align: center;
            padding: 3rem 0;
        }
        
        .hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--accent), #9b59b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .filters {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 10px;
            margin: 2rem 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--accent);
        }
        
        .filter-group select,
        .filter-group input {
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .showtimes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .showtime-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 0;
            transition: all 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .showtime-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: var(--accent);
        }
        
        .movie-image-container {
            width: 100%;
            height: 300px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .movie-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .showtime-card:hover .movie-image {
            transform: scale(1.05);
        }
        
        .movie-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--charcoal), var(--slate));
            color: var(--text-light);
            font-size: 3rem;
            opacity: 0.5;
        }
        
        .showtime-card-content {
            padding: 1.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .showtime-card h3 {
            color: var(--accent);
            margin-bottom: 0.5rem;
            font-size: 1.3rem;
        }
        
        .showtime-card .time {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 0.5rem 0;
            color: var(--text-light);
        }
        
        .showtime-card .cinema {
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }
        
        .showtime-card .cinema-name {
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 0.25rem;
        }
        
        .showtime-card .cinema-address {
            font-size: 0.9rem;
            opacity: 0.9;
            color: var(--text-light);
            margin-bottom: 1rem;
            line-height: 1.4;
        }
        
        .buy-btn {
            display: inline-block;
            width: 100%;
            padding: 0.75rem;
            background: var(--accent);
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }
        
        .buy-btn:hover {
            background: var(--accent-hover);
            transform: scale(1.02);
        }
        
        .city-input-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .city-input-group input {
            flex: 1;
        }
        
        .search-btn {
            padding: 0.75rem 1.5rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .search-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }
        
        .location-input-group {
            position: relative;
        }
        
        .location-input-group input {
            width: 100%;
        }
        
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--charcoal);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-top: none;
            border-radius: 0 0 5px 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .suggestions-dropdown.show {
            display: block;
        }
        
        .suggestion-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s;
        }
        
        .suggestion-item:hover {
            background: var(--accent);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-item small {
            opacity: 0.7;
        }
        
        /* Footer */
        footer {
            background: rgba(26, 31, 58, 0.95);
            padding: 2rem 0;
            margin-top: 4rem;
            text-align: center;
        }
        
        .visitor-counter {
            font-size: 1.2rem;
            color: var(--accent);
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.5rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }
            
            nav {
                flex-direction: column;
                gap: 1rem;
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav class="container">
            <div class="logo">CineStream</div>
            <div class="nav-links">
                <div class="lang-selector">
                    <a href="/set-language/en" class="lang-btn {{ 'active' if lang == 'en' else '' }}">EN</a>
                    <a href="/set-language/ua" class="lang-btn {{ 'active' if lang == 'ua' else '' }}">UA</a>
                    <a href="/set-language/ru" class="lang-btn {{ 'active' if lang == 'ru' else '' }}">RU</a>
                </div>
                <a href="{{ donation_url }}" target="_blank" class="donate-btn">{{ translations.donate }}</a>
            </div>
        </nav>
    </header>
    
    <main class="container">
        <div class="hero">
            <h1>{{ translations.title }}</h1>
            <p>{{ translations.select_city }}</p>
        </div>
        
        <div class="filters">
            <div class="filter-group" style="grid-column: span 2;">
                <label>{{ translations.select_city }}</label>
                <div class="location-input-group">
                    <input type="text" id="city-input" placeholder="Enter city name..." autocomplete="off">
                    <div id="city-suggestions" class="suggestions-dropdown"></div>
                </div>
            </div>
            
            <div class="filter-group">
                <label>Country</label>
                <select id="country-select">
                    <option value="">All Countries</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>&nbsp;</label>
                <button id="search-btn" class="search-btn">üîç Search Showtimes</button>
            </div>
            
            <div class="filter-group">
                <label>{{ translations.filter_by_format }}</label>
                <select id="format-filter">
                    <option value="">All Formats</option>
                    <option value="2D">2D</option>
                    <option value="3D">3D</option>
                    <option value="IMAX">IMAX</option>
                    <option value="4DX">4DX</option>
                    <option value="Dolby Atmos">Dolby Atmos</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>{{ translations.filter_by_language }}</label>
                <select id="language-filter">
                    <option value="">All Languages</option>
                    <option value="Ukrainian">Ukrainian</option>
                    <option value="English">English</option>
                    <option value="Russian">Russian</option>
                    <option value="Original">Original</option>
                </select>
            </div>
        </div>
        
        <div id="showtimes-container">
            <div class="empty-state">
                <p>{{ translations.select_city }}</p>
            </div>
        </div>
    </main>
    
    <footer>
        <div class="container">
            <p class="visitor-counter">{{ translations.visitor_count }}: {{ visitor_count }}</p>
            <p style="margin-top: 1rem; opacity: 0.7;">¬© 2025 CineStream. All rights reserved.</p>
        </div>
    </footer>
    
    <script>
        const cityInput = document.getElementById('city-input');
        const countrySelect = document.getElementById('country-select');
        const citySuggestions = document.getElementById('city-suggestions');
        const searchBtn = document.getElementById('search-btn');
        const formatFilter = document.getElementById('format-filter');
        const languageFilter = document.getElementById('language-filter');
        const container = document.getElementById('showtimes-container');
        
        let currentCity = null;
        let currentCountry = null;
        let showtimes = [];
        let pollingInterval = null;
        let autocompleteTimeout = null;
        
        // Comprehensive country list (ISO 3166-1)
        const countries = [
            "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Argentina", "Armenia", 
            "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", 
            "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", 
            "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cambodia", 
            "Cameroon", "Canada", "Cape Verde", "Central African Republic", "Chad", "Chile", 
            "China", "Colombia", "Comoros", "Congo", "Costa Rica", "Croatia", "Cuba", "Cyprus", 
            "Czech Republic", "Denmark", "Djibouti", "Dominican Republic", "Ecuador", "Egypt", 
            "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", 
            "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", 
            "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", 
            "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", 
            "Israel", "Italy", "Ivory Coast", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", 
            "Kiribati", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", 
            "Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia", 
            "Maldives", "Mali", "Malta", "Mauritania", "Mauritius", "Mexico", "Moldova", "Monaco", 
            "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru", 
            "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", 
            "North Macedonia", "Norway", "Oman", "Pakistan", "Palau", "Palestine", "Panama", 
            "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", 
            "Romania", "Russia", "Rwanda", "Saint Lucia", "Samoa", "San Marino", "Saudi Arabia", 
            "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", 
            "Solomon Islands", "Somalia", "South Africa", "South Korea", "South Sudan", "Spain", 
            "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan", 
            "Tajikistan", "Tanzania", "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", 
            "Tunisia", "Turkey", "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", 
            "United Kingdom", "United States", "Uruguay", "Uzbekistan", "Vanuatu", "Vatican City", 
            "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"
        ];
        
        // Populate country dropdown
        countries.forEach(country => {
            const option = document.createElement('option');
            option.value = country;
            option.textContent = country;
            countrySelect.appendChild(option);
        });
        
        // City autocomplete using OpenStreetMap Nominatim (free API)
        cityInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            
            // Clear previous timeout
            if (autocompleteTimeout) {
                clearTimeout(autocompleteTimeout);
            }
            
            if (query.length < 2) {
                citySuggestions.classList.remove('show');
                return;
            }
            
            // Debounce API calls (500ms delay)
            autocompleteTimeout = setTimeout(() => fetchCitySuggestions(query), 500);
        });
        
        async function fetchCitySuggestions(query) {
            try {
                const countryCode = getCountryCode(countrySelect.value);
                let url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&featuretype=city`;
                
                if (countryCode) {
                    url += `&countrycodes=${countryCode}`;
                }
                
                const response = await fetch(url, {
                    headers: { 'Accept-Language': '{{ lang }}' }
                });
                
                const results = await response.json();
                displayCitySuggestions(results);
            } catch (e) {
                console.error('Autocomplete error:', e);
                citySuggestions.classList.remove('show');
            }
        }
        
        function displayCitySuggestions(results) {
            if (results.length === 0) {
                citySuggestions.classList.remove('show');
                return;
            }
            
            citySuggestions.innerHTML = '';
            results.forEach(result => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                
                // Extract city, state, and country from display_name
                // Format is typically: "City, State/Province, Country" or "City, Country"
                const parts = result.display_name.split(', ');
                const cityName = parts[0];
                let stateName = '';
                let countryName = parts[parts.length - 1];
                
                // If there are 3+ parts, the middle ones are likely state/province
                if (parts.length >= 3) {
                    // Try to identify state (usually second-to-last before country)
                    // But could be multiple parts like "New York, NY, USA"
                    const potentialState = parts.slice(1, -1).join(', ');
                    stateName = potentialState;
                }
                
                // Build display text
                let displayText = cityName;
                if (stateName) {
                    displayText += ` <small>(${stateName}, ${countryName})</small>`;
                } else {
                    displayText += ` <small>(${countryName})</small>`;
                }
                
                div.innerHTML = displayText;
                
                // Store full location data in data attributes
                div.dataset.city = cityName;
                div.dataset.state = stateName;
                div.dataset.country = countryName;
                
                div.addEventListener('click', () => {
                    cityInput.value = cityName;
                    
                    // Try to match and select the country
                    const matchedCountry = countries.find(c => 
                        c.toLowerCase() === countryName.toLowerCase() ||
                        countryName.toLowerCase().includes(c.toLowerCase())
                    );
                    if (matchedCountry) {
                        countrySelect.value = matchedCountry;
                    }
                    
                    // Store state for later use
                    if (stateName) {
                        cityInput.dataset.state = stateName;
                    } else {
                        delete cityInput.dataset.state;
                    }
                    
                    citySuggestions.classList.remove('show');
                });
                
                citySuggestions.appendChild(div);
            });
            
            citySuggestions.classList.add('show');
        }
        
        // Complete ISO 3166-1 alpha-2 country codes for Nominatim (matches all countries in list)
        function getCountryCode(countryName) {
            const codes = {
                "Afghanistan": "af", "Albania": "al", "Algeria": "dz", "Andorra": "ad", 
                "Angola": "ao", "Argentina": "ar", "Armenia": "am", "Australia": "au", 
                "Austria": "at", "Azerbaijan": "az", "Bahamas": "bs", "Bahrain": "bh", 
                "Bangladesh": "bd", "Barbados": "bb", "Belarus": "by", "Belgium": "be", 
                "Belize": "bz", "Benin": "bj", "Bhutan": "bt", "Bolivia": "bo", 
                "Bosnia and Herzegovina": "ba", "Botswana": "bw", "Brazil": "br", 
                "Brunei": "bn", "Bulgaria": "bg", "Burkina Faso": "bf", "Burundi": "bi", 
                "Cambodia": "kh", "Cameroon": "cm", "Canada": "ca", "Cape Verde": "cv", 
                "Central African Republic": "cf", "Chad": "td", "Chile": "cl", "China": "cn", 
                "Colombia": "co", "Comoros": "km", "Congo": "cg", "Costa Rica": "cr", 
                "Croatia": "hr", "Cuba": "cu", "Cyprus": "cy", "Czech Republic": "cz", 
                "Denmark": "dk", "Djibouti": "dj", "Dominican Republic": "do", "Ecuador": "ec", 
                "Egypt": "eg", "El Salvador": "sv", "Equatorial Guinea": "gq", "Eritrea": "er", 
                "Estonia": "ee", "Eswatini": "sz", "Ethiopia": "et", "Fiji": "fj", 
                "Finland": "fi", "France": "fr", "Gabon": "ga", "Gambia": "gm", 
                "Georgia": "ge", "Germany": "de", "Ghana": "gh", "Greece": "gr", 
                "Grenada": "gd", "Guatemala": "gt", "Guinea": "gn", "Guinea-Bissau": "gw", 
                "Guyana": "gy", "Haiti": "ht", "Honduras": "hn", "Hungary": "hu", 
                "Iceland": "is", "India": "in", "Indonesia": "id", "Iran": "ir", 
                "Iraq": "iq", "Ireland": "ie", "Israel": "il", "Italy": "it", 
                "Ivory Coast": "ci", "Jamaica": "jm", "Japan": "jp", "Jordan": "jo", 
                "Kazakhstan": "kz", "Kenya": "ke", "Kiribati": "ki", "Kuwait": "kw", 
                "Kyrgyzstan": "kg", "Laos": "la", "Latvia": "lv", "Lebanon": "lb", 
                "Lesotho": "ls", "Liberia": "lr", "Libya": "ly", "Liechtenstein": "li", 
                "Lithuania": "lt", "Luxembourg": "lu", "Madagascar": "mg", "Malawi": "mw", 
                "Malaysia": "my", "Maldives": "mv", "Mali": "ml", "Malta": "mt", 
                "Mauritania": "mr", "Mauritius": "mu", "Mexico": "mx", "Moldova": "md", 
                "Monaco": "mc", "Mongolia": "mn", "Montenegro": "me", "Morocco": "ma", 
                "Mozambique": "mz", "Myanmar": "mm", "Namibia": "na", "Nauru": "nr", 
                "Nepal": "np", "Netherlands": "nl", "New Zealand": "nz", "Nicaragua": "ni", 
                "Niger": "ne", "Nigeria": "ng", "North Korea": "kp", "North Macedonia": "mk", 
                "Norway": "no", "Oman": "om", "Pakistan": "pk", "Palau": "pw", 
                "Palestine": "ps", "Panama": "pa", "Papua New Guinea": "pg", "Paraguay": "py", 
                "Peru": "pe", "Philippines": "ph", "Poland": "pl", "Portugal": "pt", 
                "Qatar": "qa", "Romania": "ro", "Russia": "ru", "Rwanda": "rw", 
                "Saint Lucia": "lc", "Samoa": "ws", "San Marino": "sm", "Saudi Arabia": "sa", 
                "Senegal": "sn", "Serbia": "rs", "Seychelles": "sc", "Sierra Leone": "sl", 
                "Singapore": "sg", "Slovakia": "sk", "Slovenia": "si", "Solomon Islands": "sb", 
                "Somalia": "so", "South Africa": "za", "South Korea": "kr", "South Sudan": "ss", 
                "Spain": "es", "Sri Lanka": "lk", "Sudan": "sd", "Suriname": "sr", 
                "Sweden": "se", "Switzerland": "ch", "Syria": "sy", "Taiwan": "tw", 
                "Tajikistan": "tj", "Tanzania": "tz", "Thailand": "th", "Timor-Leste": "tl", 
                "Togo": "tg", "Tonga": "to", "Trinidad and Tobago": "tt", "Tunisia": "tn", 
                "Turkey": "tr", "Turkmenistan": "tm", "Tuvalu": "tv", "Uganda": "ug", 
                "Ukraine": "ua", "United Arab Emirates": "ae", "United Kingdom": "gb", 
                "United States": "us", "Uruguay": "uy", "Uzbekistan": "uz", "Vanuatu": "vu", 
                "Vatican City": "va", "Venezuela": "ve", "Vietnam": "vn", "Yemen": "ye", 
                "Zambia": "zm", "Zimbabwe": "zw"
            };
            return codes[countryName] || '';
        }
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!cityInput.contains(e.target) && !citySuggestions.contains(e.target)) {
                citySuggestions.classList.remove('show');
            }
        });
        
        // Search button click handler
        searchBtn.addEventListener('click', async () => {
            const city = cityInput.value.trim();
            const country = countrySelect.value;
            const state = cityInput.dataset.state || '';  // Get state from autocomplete if available
            
            // Hide suggestions
            citySuggestions.classList.remove('show');
            
            // Clear any existing polling
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            
            if (!city) {
                container.innerHTML = '<div class="empty-state"><p>Please enter a city name</p></div>';
                return;
            }
            
            if (!country) {
                container.innerHTML = '<div class="empty-state"><p>Please select a country</p></div>';
                return;
            }
            
            currentCity = city;
            currentCountry = country;
            
            container.innerHTML = '<div class="loading">{{ translations.loading }}</div>';
            
            // Trigger scraping if needed
            await fetchShowtimes(city, country, state);
        });
        
        // Also trigger search on Enter key in city input
        cityInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                citySuggestions.classList.remove('show');
                searchBtn.click();
            }
        });
        
        // Clear state when city input changes manually
        cityInput.addEventListener('input', (e) => {
            if (!e.target.dataset.state) {
                // Only clear if user is typing (not from autocomplete selection)
                delete cityInput.dataset.state;
            }
        });
        
        async function fetchShowtimes(city, country, state = '') {
            try {
                const scrapeResponse = await fetch('/api/scrape', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        city: city, 
                        country: country,
                        state: state
                    })
                });
                
                const data = await scrapeResponse.json();
                
                if (scrapeResponse.status === 202) {
                    // Scraping in progress by another request - start polling
                    const locationId = state ? `${city}, ${state}, ${country}` : `${city}, ${country}`;
                    container.innerHTML = '<div class="loading">üé¨ {{ translations.loading }} (scraping in progress...)</div>';
                    startPolling(locationId);
                    return;
                }
                
                // Check if response contains showtimes directly
                if (data.showtimes && Array.isArray(data.showtimes)) {
                    // Use showtimes from response immediately!
                    showtimes = applyFilters(data.showtimes);
                    renderShowtimes();
                } else if (data.status === 'success' || data.status === 'fresh') {
                    // Fallback: fetch showtimes separately (shouldn't happen with new API)
                    const locationId = state ? `${city}, ${state}, ${country}` : `${city}, ${country}`;
                    await loadShowtimes(locationId);
                } else if (data.status === 'error') {
                    container.innerHTML = `<div class="empty-state"><p>Error: ${data.message}</p></div>`;
                }
            } catch (e) {
                console.error('Scrape error:', e);
                container.innerHTML = '<div class="empty-state"><p>Error connecting to server</p></div>';
            }
        }
        
        function startPolling(locationId) {
            // Poll every 2 seconds for status updates
            pollingInterval = setInterval(async () => {
                try {
                    const statusResponse = await fetch(`/api/scrape/status/${encodeURIComponent(locationId)}`);
                    const statusData = await statusResponse.json();
                    
                    if (statusData.ready || statusData.status === 'fresh') {
                        // Data is ready! Stop polling and load showtimes
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        await loadShowtimes(locationId);
                    } else if (statusData.status === 'stale' || statusData.status === 'error') {
                        // Scraping failed, stop polling
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        container.innerHTML = '<div class="empty-state"><p>{{ translations.no_showtimes }}</p></div>';
                    }
                    // Otherwise keep polling (status is 'processing')
                } catch (e) {
                    console.error('Polling error:', e);
                }
            }, 2000); // Poll every 2 seconds
        }
        
        async function loadShowtimes(locationId) {
            const params = new URLSearchParams({city_name: locationId});
            if (formatFilter.value) params.append('format', formatFilter.value);
            if (languageFilter.value) params.append('language', languageFilter.value);
            
            try {
                const response = await fetch(`/api/showtimes?${params}`);
                showtimes = await response.json();
                renderShowtimes();
            } catch (e) {
                console.error('Error loading showtimes:', e);
                container.innerHTML = '<div class="empty-state"><p>Error loading showtimes</p></div>';
            }
        }
        
        function applyFilters(data) {
            let filtered = [...data];
            
            if (genreFilter.value) {
                filtered = filtered.filter(s => 
                    (s.movie?.genre || '').toLowerCase().includes(genreFilter.value.toLowerCase())
                );
            }
            if (formatFilter.value) {
                filtered = filtered.filter(s => s.format === formatFilter.value);
            }
            if (languageFilter.value) {
                filtered = filtered.filter(s => 
                    (s.language || '').toLowerCase().includes(languageFilter.value.toLowerCase())
                );
            }
            
            return filtered;
        }
        
        function renderShowtimes() {
            if (showtimes.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>{{ translations.no_showtimes }}</p></div>';
                return;
            }
            
            container.innerHTML = '<div class="showtimes-grid"></div>';
            const grid = container.querySelector('.showtimes-grid');
            
            showtimes.forEach(st => {
                const card = document.createElement('div');
                card.className = 'showtime-card';
                
                const movieTitle = st.movie?.en || st.movie?.local || st.movie?.ua || st.movie?.ru || 'Unknown Movie';
                const startTime = new Date(st.start_time).toLocaleString('{{ lang }}');
                const cinemaName = st.cinema_name || st.cinema_id || 'Unknown Cinema';
                const cinemaAddress = st.cinema_address || '';
                const hallInfo = st.hall ? ` | ${st.hall}` : '';
                
                // Movie image
                const imagePath = st.movie_image_path || '';
                const imageHtml = imagePath 
                    ? `<img src="${imagePath}" alt="${movieTitle}" class="movie-image" loading="lazy">`
                    : `<div class="movie-image-placeholder">üé¨</div>`;
                
                // Cinema address display
                const cinemaAddressHtml = cinemaAddress
                    ? `<div class="cinema-address">üìç ${cinemaAddress}</div>`
                    : '';
                
                card.innerHTML = `
                    <div class="movie-image-container">
                        ${imageHtml}
                    </div>
                    <div class="showtime-card-content">
                        <h3>${movieTitle}</h3>
                        <div class="time">${startTime}</div>
                        <div class="cinema">
                            <div class="cinema-name">${cinemaName}</div>
                            ${cinemaAddressHtml}
                        </div>
                        <div style="margin-top: auto; padding-top: 1rem;">
                            <div style="margin-bottom: 0.5rem; opacity: 0.8;">${st.format || '2D'} | ${st.language || ''}${hallInfo} | ${st.price || ''}</div>
                            <a href="${st.buy_link || '#'}" target="_blank" class="buy-btn">{{ translations.buy_tickets }}</a>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        // Filter event listeners
        [formatFilter, languageFilter].forEach(filter => {
            filter.addEventListener('change', () => {
                if (currentCity) {
                    const locationId = currentCountry ? `${currentCity}, ${currentCountry}` : currentCity;
                    loadShowtimes(locationId);
                }
            });
        });
        
        // Cleanup polling on page unload
        window.addEventListener('beforeunload', () => {
            if (pollingInterval) clearInterval(pollingInterval);
        });
    </script>
</body>
</html>

